<!-- Dashboard Mobile-First Responsive - SISTEMATO -->

<!-- FAB per mobile - COMPLETAMENTE SISTEMATO -->
<button
  class="fab-mobile fw-bold d-md-none"
  (click)="openCreateModal(createProductModal)"
  title="Aggiungi Prodotto"
>
  <i class="bi bi-plus-lg fab-mobile fw-bold"></i>
</button>

<div class="container-fluid p-2 p-md-5 pt-1 font-PermanentGotham">
  <!-- DESKTOP BUTTON -->
  <button
    class="btn ms-3 my-3 btn-luxury-gold d-none d-md-block"
    (click)="openCreateModal(createProductModal)"
  >
    <i class="bi bi-plus-circle me-2"></i>Aggiungi Nuovo Prodotto
  </button>
  <!-- ðŸ†• FILTRI AVANZATI - MOBILE RESPONSIVE -->
  <div class="row g-2 mb-3">
    <!-- Filtro per testo -->
    <div class="col-12 col-md-8">
      <div class="input-group input-group-luxury">
        <span class="input-group-text bg-dark text-gold">
          <i class="bi bi-search"></i>
        </span>
        <input
          type="text"
          class="form-control form-control-luxury"
          placeholder="Cerca per titolo o ingredienti..."
          [(ngModel)]="searchText"
          (input)="filterByText($event)"
        />
      </div>
    </div>

    <!-- Filtro per categoria e reset -->
    <div class="col-8 col-md-3">
      <select
        class="form-select form-select-luxury"
        [(ngModel)]="searchCategory"
        (change)="filterByCategory($event)"
      >
        <option value="">Tutte le categorie</option>
        <option *ngFor="let category of categories" [value]="category">
          {{ category }}
        </option>
      </select>
    </div>

    <!-- Pulsante reset -->
    <div class="col-4 col-md-1">
      <button
        class="btn btn-outline-gold w-100"
        (click)="resetFilters()"
        title="Reset filtri"
      >
        <i class="bi bi-arrow-clockwise"></i>
      </button>
    </div>
  </div>

  <!-- Indicatore risultati -->
  <div class="mb-3" *ngIf="searchText || searchCategory">
    <small class="text-luxury-muted">
      <i class="bi bi-funnel me-1"></i>
      Mostrando {{ filteredMenu.length }} di {{ menu.length }} prodotti
      <span *ngIf="searchText" class="d-none d-sm-inline">
        â€¢ Testo: "{{ searchText }}"</span
      >
      <span *ngIf="searchCategory" class="d-none d-sm-inline">
        â€¢ Categoria: "{{ searchCategory }}"</span
      >
    </small>
  </div>

  <!-- MOBILE: Cards Layout (â‰¤768px) -->
  <div class="d-md-none pb-5 mb-5" >
    <div class="row g-3 mb-5">
      <div class="col-12" *ngFor="let item of filteredMenu">
        <div class="card card-luxury-mobile">
          <div class="card-body p-3">
            <!-- ðŸ”§ LAYOUT MOBILE NORMALE -->
            <div *ngIf="!editMode[item.id]" class="d-flex align-items-start gap-3 mb-3">
              <div class="image-container product-image-mobile">
                <img
                  [src]="getImageUrl(item.img)"
                  alt="{{ item.titolo }}"
                  class="product-image-mobile"
                />
              </div>

              <div class="flex-grow-1 min-width-0">
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start gap-2">
                  <div class="flex-grow-1 min-width-0">
                    <h6 class="card-title text-light mb-1">{{ item.titolo }}</h6>
                    <span class="badge badge-luxury-category">{{ item.categoria }}</span>
                  </div>
                  <div class="price-container flex-shrink-0">
                    <span class="price-badge">{{ item.prezzo | currency : "EUR" }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- ðŸ”§ LAYOUT MOBILE EDIT MODE - CON PREVIEW IMMAGINE -->
            <div *ngIf="editMode[item.id]" class="edit-mode-mobile mb-3">
              <!-- Immagine Attuale + Upload -->
              <div class="mb-3">
                <label class="form-label text-luxury-muted small">Immagine:</label>
                <div class="d-flex align-items-center gap-3">
                  <!-- Preview immagine attuale -->
                  <div class="current-image-preview">
                    <img
                      [src]="getImageUrl(item.img)"
                      alt="{{ item.titolo }}"
                      class="img-thumbnail"
                      style="width: 60px; height: 60px; object-fit: cover;"
                    />
                  </div>
                  <!-- Bottone per cambiare immagine -->
                  <div class="file-upload-container-mobile">
                    <input
                      type="file"
                      accept="image/*"
                      (change)="onImageSelect($event, item)"
                      class="file-input"
                      [id]="'file-' + item.id"
                      style="display: none;"
                    />
                    <label [for]="'file-' + item.id" class="btn btn-outline-gold btn-sm text-white">
                      <i class="bi bi-camera-fill me-1 text-white"></i>Cambia
                    </label>
                  </div>
                </div>
              </div>

              <!-- Titolo -->
              <div class="mb-3">
                <label class="form-label text-luxury-muted small">Titolo:</label>
                <input
                  [(ngModel)]="item.titolo"
                  class="form-control form-control-sm form-control-luxury"
                  placeholder="Titolo"
                />
              </div>

              <!-- Prezzo -->
              <div class="mb-3">
                <label class="form-label text-luxury-muted small">Prezzo:</label>
                <div class="input-group input-group-sm">
                  <input
                    [(ngModel)]="item.prezzo"
                    type="number"
                    step="0.01"
                    class="form-control form-control-luxury"
                    placeholder="0.00"
                  />
                  <span class="input-group-text price-euro">â‚¬</span>
                </div>
              </div>
            </div>

            <!-- Ingredienti -->
            <div class="mb-3">
              <small class="text-luxury-muted d-block mb-1">Ingredienti:</small>
              <input
                *ngIf="editMode[item.id]"
                [(ngModel)]="item.ingredienti"
                class="form-control form-control-sm form-control-luxury"
                placeholder="Ingredienti"
              />
              <p *ngIf="!editMode[item.id]" class="text-light small mb-0">
                {{ item.ingredienti }}
              </p>
            </div>

            <!-- Status e categoria -->
            <div *ngIf="!editMode[item.id]" class="d-flex justify-content-between align-items-center mb-3">
              <span class="availability-status">
                <i
                  class="bi {{
                    item.disponibile
                      ? 'bi-check-circle-fill text-success'
                      : 'bi-x-circle-fill text-danger'
                  }}"
                ></i>
                <span class="ms-1 text-light">{{
                  item.disponibile ? "Disponibile" : "Non disponibile"
                }}</span>
              </span>
            </div>

            <!-- EDIT MODE: Categoria e DisponibilitÃ  -->
            <div *ngIf="editMode[item.id]" class="row g-2 mb-3">
              <div class="col-7">
                <label class="form-label text-luxury-muted small">Categoria:</label>
                <select
                  [(ngModel)]="item.categoria"
                  class="form-select form-select-sm form-select-luxury"
                >
                  <option *ngFor="let category of categories" [value]="category">
                    {{ category }}
                  </option>
                </select>
              </div>
              <div class="col-5 d-flex align-items-end">
                <div class="form-check">
                  <input
                    [(ngModel)]="item.disponibile"
                    type="checkbox"
                    class="form-check-input form-check-luxury"
                    [id]="'available-' + item.id"
                  />
                  <label [for]="'available-' + item.id" class="form-check-label text-light small">
                    Disponibile
                  </label>
                </div>
              </div>
            </div>

            <!-- Azioni -->

            <div class="d-flex gap-2 justify-content-end">
              <button
                class="btn btn-danger-gold btn-sm"
                (click)="delete(item.id)"
              >
                <i class="bi bi-trash3"></i>
              </button>
              <button
                class="btn btn-luxury-edit btn-sm"
                (click)="toggleEditMode(item.id)"
              >
                <i
                  class="bi {{
                    editMode[item.id] ? 'bi-check-lg' : 'bi-pencil'
                  }}"
                ></i>
                <span class="d-none d-sm-inline ms-1">
                  {{ editMode[item.id] ? "Conferma" : "Modifica" }}
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DESKTOP: Table Layout SISTEMATA (â‰¥768px) -->
  <div class="d-none d-md-block">
    <div class="table-responsive table-luxury-container">
      <table class="table table-bordered table-luxury table-fixed">
        <thead>
          <tr>
            <th class="border-luxury col-id">#</th>
            <th class="text-center border-luxury col-image">Immagine</th>
            <th class="border-luxury col-title">Titolo</th>
            <th class="border-luxury col-ingredients">Ingredienti</th>
            <th class="text-center border-luxury col-price">Prezzo</th>
            <th class="text-center border-luxury col-category">Categoria</th>
            <th class="text-center border-luxury col-available">Disponibile</th>
            <th class="text-center col-actions">Azioni</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredMenu">
            <td class="table-bg-luxury border-luxury col-id">{{ item.id }}</td>
            <td class="text-center table-bg-luxury border-luxury col-image">
              <img
                *ngIf="!editMode[item.id]"
                [src]="getImageUrl(item.img)"
                alt="{{ item.titolo }}"
                class="product-image-desktop"
              />
              <!-- Preview + Upload in edit mode -->
              <div *ngIf="editMode[item.id]" class="desktop-image-edit d-flex flex-column align-items-center gap-2">
                <!-- Preview immagine attuale -->
                <img
                  [src]="getImageUrl(item.img)"
                  alt="{{ item.titolo }}"
                  class="product-image-desktop-small"
                />
                <!-- Bottone upload -->
                <input
                  type="file"
                  accept="image/*"
                  (change)="onImageSelect($event, item)"
                  class="file-input"
                  [id]="'file-desktop-' + item.id"
                  style="display: none;"
                />
                <label [for]="'file-desktop-' + item.id" class="btn btn-outline-light btn-xs">
                  <i class="bi bi-camera-fill"></i>
                </label>
              </div>
            </td>
            <td class="table-bg-luxury border-luxury col-title">
              <input
                *ngIf="editMode[item.id]"
                [(ngModel)]="item.titolo"
                class="form-control form-control-sm"
              />
              <span *ngIf="!editMode[item.id]" class="text-light">{{
                item.titolo
              }}</span>
            </td>
            <td class="table-bg-luxury border-luxury col-ingredients">
              <input
                *ngIf="editMode[item.id]"
                [(ngModel)]="item.ingredienti"
                class="form-control form-control-sm"
              />
              <span *ngIf="!editMode[item.id]" class="text-light text-truncate">{{
                item.ingredienti
              }}</span>
            </td>
            <td class="text-center table-bg-luxury border-luxury col-price">
              <input
                *ngIf="editMode[item.id]"
                [(ngModel)]="item.prezzo"
                type="number"
                step="0.01"
                class="form-control form-control-sm"
                style="width: 80px;"
              />
              <span *ngIf="!editMode[item.id]" class="text-warning fw-bold">
                {{ item.prezzo | currency : "EUR" }}
              </span>
            </td>
            <td class="text-center table-bg-luxury border-luxury col-category">
              <select
                *ngIf="editMode[item.id]"
                [(ngModel)]="item.categoria"
                class="form-select form-select-sm"
                style="width: 120px;"
              >
                <option *ngFor="let category of categories" [value]="category">
                  {{ category }}
                </option>
              </select>
              <span *ngIf="!editMode[item.id]" class="text-light">{{
                item.categoria
              }}</span>
            </td>
            <td class="text-center table-bg-luxury border-luxury col-available">
              <input
                *ngIf="editMode[item.id]"
                [(ngModel)]="item.disponibile"
                type="checkbox"
                class="form-check-input"
              />
              <span *ngIf="!editMode[item.id]">
                <i
                  class="bi {{
                    item.disponibile
                      ? 'bi-check-circle-fill text-success'
                      : 'bi-x-circle-fill text-danger'
                  }}"
                ></i>
                <span class="text-light ms-1 d-none d-lg-inline">{{
                  item.disponibile ? "SÃ¬" : "No"
                }}</span>
              </span>
            </td>
            <td class="text-center table-bg-luxury border-luxury col-actions">
              <div class="d-flex gap-1 justify-content-center">
                <button
                  class="btn btn-danger-gold btn-sm"
                  (click)="delete(item.id)"
                  title="Elimina"
                >
                  <i class="bi bi-trash3"></i>
                </button>
                <button
                  class="btn btn-luxury-edit btn-sm"
                  (click)="toggleEditMode(item.id)"
                  title="{{ editMode[item.id] ? 'Conferma' : 'Modifica' }}"
                >
                  <i
                    class="bi {{
                      editMode[item.id] ? 'bi-check-lg' : 'bi-pencil'
                    }}"
                  ></i>
                  <span class="d-none d-xl-inline ms-1">
                    {{ editMode[item.id] ? "Conferma" : "Modifica" }}
                  </span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal per creare prodotto - LUXURY STYLED -->
  <ng-template #createProductModal let-modal>
  <div class="modal-header modal-header-luxury">
    <h4 class="modal-title text-light">
      <i class="bi bi-plus-circle me-2 text-gold"></i>Aggiungi Nuovo Prodotto
    </h4>
    <button
      type="button"
      class="btn-close btn-close-white"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body modal-body-luxury">
    <form (ngSubmit)="createProduct(modal)">
      <div class="mb-3">
        <label for="productName" class="form-label text-light">
          <i class="bi bi-card-text me-2 text-gold"></i>Titolo
        </label>
        <input
          type="text"
          class="form-control form-control-luxury"
          id="productName"
          [(ngModel)]="newProduct.titolo"
          name="titolo"
          placeholder="Nome del piatto"
          required
        />
      </div>

      <div class="mb-3">
        <label for="productIngredients" class="form-label text-light">
          <i class="bi bi-list-ul me-2 text-gold"></i>Ingredienti
        </label>
        <textarea
          class="form-control form-control-luxury"
          id="productIngredients"
          [(ngModel)]="newProduct.ingredienti"
          name="ingredienti"
          placeholder="Elenco ingredienti separati da virgola"
          rows="2"
          required
        ></textarea>
      </div>

      <!-- FILE UPLOAD SECTION -->
      <div class="mb-3">
        <label class="form-label text-light">
          <i class="bi bi-image me-2 text-gold"></i>Immagine Prodotto
        </label>

        <!-- File Upload Area -->
        <div class="file-upload-modal-container">
          <input
            type="file"
            accept="image/*"
            (change)="onModalImageSelect($event)"
            class="file-input-modal"
            id="modalFileInput"
          />
          <label for="modalFileInput" class="file-upload-modal-area">
            <div class="upload-content">
              <!-- Preview immagine se caricata -->
              <div *ngIf="imagePreview" class="image-preview-container">
                <img [src]="imagePreview" alt="Preview" class="image-preview" />
                <div class="upload-overlay">
                  <i class="bi bi-camera-fill"></i>
                  <span>Cambia Immagine</span>
                </div>
              </div>

              <!-- Area upload vuota -->
              <div *ngIf="!imagePreview" class="upload-placeholder">
                <i class="bi bi-cloud-upload-fill"></i>
                <h6 class="text-light mt-2 mb-1">Carica Immagine</h6>
                <small class="text-luxury-muted">Clicca per selezionare o trascina qui</small>
                <small class="text-luxury-muted d-block">JPG, PNG, WEBP (max 5MB)</small>
              </div>
            </div>
          </label>
        </div>
      </div>

      <div class="mb-3">
        <label for="productCategory" class="form-label text-light">
          <i class="bi bi-tag me-2 text-gold"></i>Categoria
        </label>
        <select
          class="form-select form-select-luxury"
          id="productCategory"
          [(ngModel)]="newProduct.categoria"
          name="categoria"
          required
        >
          <option value="" disabled>Seleziona una categoria</option>
          <option *ngFor="let category of categories" [value]="category">
            {{ category }}
          </option>
        </select>
      </div>

      <div class="mb-3">
        <label for="productPrice" class="form-label text-light">
          <i class="bi bi-currency-euro me-2 text-gold"></i>Prezzo
        </label>
        <div class="input-group">
          <input
            type="number"
            class="form-control form-control-luxury"
            id="productPrice"
            [(ngModel)]="newProduct.prezzo"
            name="prezzo"
            placeholder="0.00"
            step="0.01"
            min="0"
            required
          />
          <span class="input-group-text price-euro-modal">â‚¬</span>
        </div>
      </div>

      <div class="mb-4 form-check d-flex align-items-center gap-3">
        <input
          type="checkbox"
          class="form-check-input form-check-luxury-modal"
          id="productAvailable"
          [(ngModel)]="newProduct.disponibile"
          name="disponibile"
        />
        <label class="form-check-label text-light mb-0" for="productAvailable">
          <i class="bi bi-check-circle me-2 text-success"></i>
          Prodotto disponibile
        </label>
      </div>

      <div class="d-grid">
        <button type="submit" class="btn btn-luxury-primary btn-lg text-white">
          <i class="bi bi-plus-circle me-2 text-white"></i>Crea Prodotto
        </button>
      </div>
    </form>
  </div>
</ng-template>
</div>
